name: CI / Deploy

# ──────────────────────────────────────────────────────────────────────────────
# Triggers
#   • Every push to main  → run tests, then deploy to Render
#   • Every pull request  → run tests only (no deploy)
# ──────────────────────────────────────────────────────────────────────────────
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ── Job 1: Lint + Test ───────────────────────────────────────────────────────
  test:
    name: Lint & Test Suite
    runs-on: ubuntu-latest

    steps:
      # 1. Check out source code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Python with pip caching
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      # 3. Install all dependencies from requirements.txt
      - name: Install dependencies
        run: pip install -r requirements.txt

      # 4. Syntax-check every Python file (catches import errors before running)
      - name: Syntax check — all Python files
        run: python -m py_compile config.py parser.py health_monitor.py database.py api.py udp_service.py simulator.py seed_data.py main.py test_all.py

      # 5. Run the full test suite
      #    • Tasks 1 & 3 (parser + health monitor) — no network needed
      #    • Tasks 2, 4, 5, 6 (UDP + MongoDB + REST API + Dashboard) — needs MONGODB_URI secret
      #    The suite skips integration tests gracefully if MongoDB is unreachable,
      #    but exits non-zero if any check that did run fails.
      - name: Run test suite
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
        run: python test_all.py

  # ── Job 2: Deploy to Render (main branch pushes only) ────────────────────────
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: test                                                       # only after tests pass
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      # Trigger Render deploy hook — no checkout needed, just an HTTP POST
      - name: Trigger Render deploy hook
        run: |
          echo "Triggering Render deployment…"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}")
          echo "Render responded: HTTP $STATUS"
          # 2xx = queued successfully
          [[ "$STATUS" =~ ^2 ]] || { echo "Deploy hook failed (HTTP $STATUS)"; exit 1; }
          echo "Deployment queued successfully."
