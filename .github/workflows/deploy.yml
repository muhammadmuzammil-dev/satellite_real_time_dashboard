name: CI / Deploy

# ──────────────────────────────────────────────────────────────────────────────
# Triggers
#   • Every push to main  → run tests (Leapcell auto-deploys from the push)
#   • Every pull request  → run tests only
#
# Deployment is handled automatically by Leapcell.
# Every push to main triggers a Leapcell build + deploy via its GitHub
# ──────────────────────────────────────────────────────────────────────────────
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ── Lint + Test ──────────────────────────────────────────────────────────────
  test:
    name: Lint & Test Suite
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Syntax check — all Python files
        run: python -m py_compile config.py parser.py health_monitor.py database.py api.py udp_service.py simulator.py seed_data.py main.py test_all.py

      - name: Whitelist runner IP in MongoDB Atlas
        env:
          ATLAS_PUBLIC_KEY: ${{ secrets.ATLAS_PUBLIC_KEY }}
          ATLAS_PRIVATE_KEY: ${{ secrets.ATLAS_PRIVATE_KEY }}
          ATLAS_PROJECT_ID: ${{ secrets.ATLAS_PROJECT_ID }}
        run: |
          RUNNER_IP=$(curl -s https://api.ipify.org)
          curl -s -u "${ATLAS_PUBLIC_KEY}:${ATLAS_PRIVATE_KEY}" \
            --digest \
            -H "Content-Type: application/json" \
            -X POST "https://cloud.mongodb.com/api/atlas/v1.0/groups/${ATLAS_PROJECT_ID}/accessList" \
            -d "[{\"ipAddress\": \"${RUNNER_IP}\", \"comment\": \"GitHub Actions CI\"}]"
          echo "RUNNER_IP=${RUNNER_IP}" >> $GITHUB_ENV
          sleep 15

      - name: Run test suite
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
        run: python test_all.py

      - name: Remove runner IP from MongoDB Atlas whitelist
        if: always()
        env:
          ATLAS_PUBLIC_KEY: ${{ secrets.ATLAS_PUBLIC_KEY }}
          ATLAS_PRIVATE_KEY: ${{ secrets.ATLAS_PRIVATE_KEY }}
          ATLAS_PROJECT_ID: ${{ secrets.ATLAS_PROJECT_ID }}
        run: |
          curl -s -u "${ATLAS_PUBLIC_KEY}:${ATLAS_PRIVATE_KEY}" \
            --digest \
            -X DELETE "https://cloud.mongodb.com/api/atlas/v1.0/groups/${ATLAS_PROJECT_ID}/accessList/${RUNNER_IP}"
