name: CI / Deploy

# ──────────────────────────────────────────────────────────────────────────────
# Triggers
#   • Every push to main  → run tests (Leapcell auto-deploys from the push)
#   • Every pull request  → run tests only
#
# Deployment is handled automatically by Leapcell.
# Every push to main triggers a Leapcell build + deploy via its GitHub
# integration.  globe.html is always served at your .leapcell.dev URL.
# ──────────────────────────────────────────────────────────────────────────────
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ── Lint + Test ──────────────────────────────────────────────────────────────
  test:
    name: Lint & Test Suite
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Syntax check — all Python files
        run: python -m py_compile config.py parser.py health_monitor.py database.py api.py udp_service.py simulator.py seed_data.py main.py test_all.py

      - name: Run test suite
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
        run: python test_all.py
