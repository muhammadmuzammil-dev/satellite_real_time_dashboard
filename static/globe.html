<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NASTP â€” 3D Satellite Globe</title>
  <script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js","three/addons/":"https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/"}}</script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:      #060a10;
      --panel:   #0d1520;
      --card:    #111b28;
      --border:  #1a2d45;
      --border2: #1f3552;
      --text:    #cdd9e5;
      --dim:     #7a8ea6;
      --dim2:    #4a5a6a;
      --accent:  #4d9ef5;
      --accent2: #2d7dd6;
      --green:   #3fb950;
      --yellow:  #e3a525;
      --red:     #f85149;
      --purple:  #bc8cff;
      --orange:  #ffa657;
      --teal:    #39c5aa;
    }
    html, body { width: 100%; height: 100%; overflow: hidden; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      font-size: 14px;
    }

    /* â”€â”€ Canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #canvas-wrap { position: fixed; inset: 0; }
    #globe-canvas { display: block; width: 100%; height: 100%; }

    /* â”€â”€ Loading Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #loading {
      position: fixed; inset: 0; z-index: 600;
      background: var(--bg);
      display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px;
      transition: opacity .5s;
    }
    .loading-globe {
      width: 64px; height: 64px; border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #1a4a8a, #061020);
      border: 2px solid var(--border2);
      animation: loadSpin 1.5s linear infinite;
      box-shadow: 0 0 30px rgba(77,158,245,.3);
    }
    @keyframes loadSpin { to { transform: rotate(360deg); } }
    .loading-text { font-size: 13px; color: var(--dim); letter-spacing: .5px; }
    .loading-bar { width: 180px; height: 2px; background: var(--border); border-radius: 1px; overflow: hidden; }
    .loading-bar-fill { height: 100%; background: var(--accent); border-radius: 1px; animation: loadBar 2s ease-in-out infinite; }
    @keyframes loadBar { 0%{width:0%} 60%{width:80%} 100%{width:100%} }

    /* â”€â”€ Top Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #topbar {
      position: fixed; top: 0; left: 0; right: 0; z-index: 200;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 24px; height: 56px;
      background: linear-gradient(180deg, rgba(6,10,16,.97) 0%, rgba(6,10,16,.65) 100%);
      border-bottom: 1px solid rgba(26,45,69,.6);
      backdrop-filter: blur(12px);
    }
    .tb-left  { display: flex; align-items: center; gap: 14px; }
    .tb-right { display: flex; align-items: center; gap: 8px; }
    .tb-logo {
      width: 36px; height: 36px; border-radius: 9px;
      background: linear-gradient(135deg, #1a3a6e, #0e2044);
      border: 1px solid var(--border2);
      display: flex; align-items: center; justify-content: center; font-size: 18px;
      flex-shrink: 0;
    }
    .tb-title { font-size: 15px; font-weight: 700; letter-spacing: -.2px; color: var(--text); }
    .tb-sub   { font-size: 10px; color: var(--dim); margin-top: 1px; letter-spacing: .3px; }
    .live-badge {
      display: flex; align-items: center; gap: 5px;
      padding: 4px 10px 4px 7px; border-radius: 20px;
      background: rgba(63,185,80,.08); border: 1px solid rgba(63,185,80,.25);
      font-size: 11px; font-weight: 700; color: var(--green); letter-spacing: .4px;
    }
    .live-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; animation: blink 1.8s ease-in-out infinite; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }

    /* â”€â”€ MongoDB status badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .db-badge {
      display: flex; align-items: center; gap: 5px;
      padding: 4px 10px 4px 7px; border-radius: 20px;
      font-size: 11px; font-weight: 700; letter-spacing: .4px;
      cursor: default; transition: background .4s, border-color .4s, color .4s;
      background: rgba(122,142,166,.08); border: 1px solid rgba(122,142,166,.25);
      color: var(--dim);
    }
    .db-badge.connected {
      background: rgba(63,185,80,.08); border-color: rgba(63,185,80,.25); color: var(--green);
    }
    .db-badge.disconnected {
      background: rgba(248,81,73,.08); border-color: rgba(248,81,73,.25); color: var(--red);
    }
    .db-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; flex-shrink: 0; }
    .db-badge.connected .db-dot { animation: blink 1.8s ease-in-out infinite; }
    .btn {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 6px 13px; border-radius: 7px;
      border: 1px solid var(--border2); background: rgba(17,27,40,.8);
      color: var(--dim); font-size: 12px; font-weight: 600;
      cursor: pointer; text-decoration: none; transition: all .15s;
      white-space: nowrap;
    }
    .btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(77,158,245,.06); }
    .btn-accent { background: var(--accent2); border-color: var(--accent); color: #fff; }
    .btn-accent:hover { opacity: .85; color: #fff; }

    /* â”€â”€ Speed Control â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .speed-ctrl { display: flex; align-items: center; gap: 6px; }
    .speed-ctrl label { font-size: 10px; color: var(--dim); white-space: nowrap; }
    .speed-ctrl input[type=range] {
      width: 70px; accent-color: var(--accent);
      cursor: pointer;
    }
    #speed-val { font-size: 11px; color: var(--accent); font-weight: 700; min-width: 30px; }

    /* â”€â”€ Satellite Legend (bottom-left) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #legend {
      position: fixed; bottom: 20px; left: 20px; z-index: 200;
      display: flex; flex-direction: column; gap: 5px;
    }
    .legend-title {
      font-size: 9px; font-weight: 700; color: var(--dim2);
      letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px;
      padding-left: 4px;
    }
    .legend-item {
      display: flex; align-items: center; gap: 9px;
      padding: 7px 12px 7px 9px; min-width: 170px;
      background: rgba(13,21,32,.88); border: 1px solid var(--border);
      border-radius: 9px; cursor: pointer; transition: all .15s;
      backdrop-filter: blur(10px);
    }
    .legend-item:hover { border-color: var(--border2); background: rgba(17,27,40,.95); transform: translateX(2px); }
    .legend-item.active { border-color: var(--accent) !important; background: rgba(77,158,245,.06); }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; box-shadow: 0 0 6px currentColor; }
    .legend-info { flex: 1; }
    .legend-name { font-size: 12px; font-weight: 600; color: var(--text); line-height: 1.2; }
    .legend-type { font-size: 10px; color: var(--dim); }
    .legend-status { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; transition: background .3s; }

    /* â”€â”€ Hover Tooltip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #tooltip {
      position: fixed; z-index: 300; pointer-events: none;
      padding: 9px 13px; background: rgba(11,19,30,.97);
      border: 1px solid var(--border2); border-radius: 9px;
      font-size: 12px; color: var(--text);
      backdrop-filter: blur(12px); white-space: nowrap;
      opacity: 0; transform: translateY(-6px);
      transition: opacity .12s, transform .12s;
      box-shadow: 0 8px 24px rgba(0,0,0,.5);
    }
    #tooltip.show { opacity: 1; transform: translateY(0); }
    .tt-name { font-size: 13px; font-weight: 700; margin-bottom: 2px; }
    .tt-meta { color: var(--dim); font-size: 11px; }
    .tt-hint { color: var(--accent); font-size: 10px; margin-top: 4px; letter-spacing: .3px; }

    /* â”€â”€ Controls Hint (bottom-right) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #hints {
      position: fixed; bottom: 20px; right: 20px; z-index: 200;
      text-align: right; pointer-events: none;
      display: flex; flex-direction: column; gap: 3px;
    }
    .hint-row { font-size: 10px; color: var(--dim2); }

    /* â”€â”€ Satellite Detail Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #sat-panel {
      position: fixed; top: 56px; right: 0; bottom: 0; z-index: 250;
      width: 390px;
      background: var(--panel);
      border-left: 1px solid var(--border);
      display: flex; flex-direction: column;
      transform: translateX(100%);
      transition: transform .35s cubic-bezier(.4, 0, .2, 1);
      overflow: hidden;
    }
    #sat-panel.open { transform: translateX(0); box-shadow: -12px 0 40px rgba(0,0,0,.5); }

    /* Panel Header */
    .ph {
      padding: 16px 18px 14px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      background: linear-gradient(180deg, rgba(17,27,40,.6) 0%, transparent 100%);
    }
    .ph-top { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .ph-close {
      width: 28px; height: 28px; border-radius: 7px;
      background: rgba(255,255,255,.04); border: 1px solid var(--border);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      font-size: 13px; color: var(--dim); transition: all .15s; flex-shrink: 0;
    }
    .ph-close:hover { color: var(--text); border-color: var(--border2); background: rgba(255,255,255,.08); }
    .ph-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
    .ph-name { font-size: 18px; font-weight: 800; flex: 1; letter-spacing: -.3px; }
    .ph-badge {
      font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 5px;
      background: rgba(77,158,245,.12); color: var(--accent); border: 1px solid rgba(77,158,245,.2);
      font-family: monospace; letter-spacing: .5px; flex-shrink: 0;
    }
    .ph-status-row { display: flex; align-items: center; gap: 8px; }
    .status-pill {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 4px 11px; border-radius: 20px;
      font-size: 11px; font-weight: 700; letter-spacing: .5px;
    }
    .status-pill.nominal  { background: rgba(63,185,80,.1);   color: var(--green);  border: 1px solid rgba(63,185,80,.3);  }
    .status-pill.warning  { background: rgba(227,165,37,.1);  color: var(--yellow); border: 1px solid rgba(227,165,37,.3); }
    .status-pill.critical { background: rgba(248,81,73,.1);   color: var(--red);    border: 1px solid rgba(248,81,73,.3);  }
    .status-pill.nodata   { background: rgba(74,90,106,.1);   color: var(--dim);    border: 1px solid rgba(74,90,106,.2);  }
    .status-pill-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
    .ph-updated { font-size: 10px; color: var(--dim); margin-left: auto; }

    /* Panel Body */
    .pb {
      flex: 1; overflow-y: auto; overflow-x: hidden;
      padding: 14px 18px 20px;
      display: flex; flex-direction: column; gap: 16px;
    }
    .pb::-webkit-scrollbar { width: 3px; }
    .pb::-webkit-scrollbar-track { background: transparent; }
    .pb::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

    /* Section label */
    .sec-lbl {
      font-size: 9px; font-weight: 800; color: var(--dim2);
      text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;
    }

    /* Orbit info grid */
    .orbit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    .orbit-cell {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 8px; padding: 9px 11px;
    }
    .orbit-cell-label { font-size: 9px; color: var(--dim); margin-bottom: 3px; text-transform: uppercase; letter-spacing: .4px; }
    .orbit-cell-val   { font-size: 15px; font-weight: 700; color: var(--text); }

    /* Metric cards */
    .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .mc {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 10px; padding: 12px 12px 10px;
      position: relative; overflow: hidden;
      transition: border-color .3s;
    }
    .mc.ok   { border-color: rgba(63,185,80,.28); }
    .mc.warn { border-color: rgba(227,165,37,.35); }
    .mc.crit { border-color: rgba(248,81,73,.35); }
    .mc-icon  { font-size: 15px; margin-bottom: 5px; line-height: 1; }
    .mc-lbl   { font-size: 9px; color: var(--dim); font-weight: 700; letter-spacing: .4px; text-transform: uppercase; margin-bottom: 4px; }
    .mc-val   { font-size: 22px; font-weight: 800; line-height: 1; margin-bottom: 1px; font-variant-numeric: tabular-nums; }
    .mc-unit  { font-size: 10px; color: var(--dim); margin-bottom: 8px; }
    .mc-bar   { height: 3px; background: rgba(255,255,255,.06); border-radius: 2px; margin-bottom: 7px; overflow: hidden; }
    .mc-bar-fill { height: 100%; border-radius: 2px; transition: width .6s ease; }
    .mc-spark { display: block; width: 100%; height: 30px; }
    .mc-nodata {
      position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
      background: rgba(11,18,28,.75); border-radius: 10px;
      font-size: 10px; color: var(--dim2); font-weight: 600; letter-spacing: .3px;
    }

    /* Alert list */
    .alert-list { display: flex; flex-direction: column; gap: 6px; }
    .alert-row {
      display: flex; align-items: flex-start; gap: 8px;
      padding: 9px 11px; border-radius: 8px;
      background: var(--card); border: 1px solid var(--border);
    }
    .alert-row.yellow { background: rgba(227,165,37,.04); border-color: rgba(227,165,37,.3); }
    .alert-row.red    { background: rgba(248,81,73,.04);  border-color: rgba(248,81,73,.3);  }
    .alert-lvl {
      font-size: 9px; font-weight: 800; padding: 2px 6px; border-radius: 4px;
      flex-shrink: 0; margin-top: 1px; letter-spacing: .5px;
    }
    .alert-lvl.yellow { background: rgba(227,165,37,.18); color: var(--yellow); }
    .alert-lvl.red    { background: rgba(248,81,73,.18);  color: var(--red);    }
    .alert-msg   { font-size: 11px; color: var(--text); line-height: 1.45; }
    .alert-field { font-size: 10px; color: var(--dim); margin-top: 2px; }
    .no-alerts {
      text-align: center; padding: 14px;
      color: var(--green); font-size: 12px; font-weight: 600;
      background: rgba(63,185,80,.04); border: 1px solid rgba(63,185,80,.18); border-radius: 8px;
    }

    /* Stats grid */
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
    .stat-cell {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 8px; padding: 9px 8px; text-align: center;
    }
    .stat-cell-lbl { font-size: 9px; color: var(--dim2); text-transform: uppercase; letter-spacing: .4px; margin-bottom: 4px; }
    .stat-cell-val { font-size: 13px; font-weight: 700; color: var(--accent); font-variant-numeric: tabular-nums; }

    /* Panel Footer */
    .pf {
      padding: 12px 18px; border-top: 1px solid var(--border);
      display: flex; gap: 8px; flex-shrink: 0;
    }
    .pf .btn { flex: 1; justify-content: center; font-size: 12px; }

    /* Loading skeleton */
    .skeleton {
      background: linear-gradient(90deg, var(--card) 25%, rgba(31,53,82,.5) 50%, var(--card) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.4s infinite;
      border-radius: 6px;
    }
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    @media (max-width: 640px) {
      #sat-panel { width: 100%; }
      #legend { display: none; }
      .tb-sub { display: none; }
    }
  </style>
</head>
<body>

<!-- Loading Screen -->
<div id="loading">
  <div class="loading-globe"></div>
  <div class="loading-text">Loading Globe Rendererâ€¦</div>
  <div class="loading-bar"><div class="loading-bar-fill"></div></div>
</div>

<!-- Three.js Canvas -->
<div id="canvas-wrap">
  <canvas id="globe-canvas"></canvas>
</div>

<!-- Top Bar -->
<div id="topbar">
  <div class="tb-left">
    <div class="tb-logo">ğŸ›°ï¸</div>
    <div>
      <div class="tb-title">NASTP Ground Control</div>
      <div class="tb-sub">3D Satellite Globe â€” Real-time Orbital Tracking</div>
    </div>
  </div>
  <div class="tb-right">
    <div class="speed-ctrl">
      <label for="speed-range">SPEED</label>
      <input type="range" id="speed-range" min="0" max="4" step="0.1" value="1">
      <span id="speed-val">10Ã—</span>
    </div>
    <div id="db-badge" class="db-badge" title="MongoDB Atlas connection status">
      <div class="db-dot"></div>
      <span id="db-status-text">MONGO</span>
    </div>
    <div class="live-badge"><div class="live-dot"></div>LIVE</div>
    <a href="/" class="btn">ğŸ“Š Dashboard</a>
  </div>
</div>

<!-- Satellite Legend -->
<div id="legend">
  <div class="legend-title">Active Satellites</div>
</div>

<!-- Hover Tooltip -->
<div id="tooltip">
  <div class="tt-name" id="tt-name">â€”</div>
  <div class="tt-meta" id="tt-meta">â€”</div>
  <div class="tt-hint">Click to view telemetry â†’</div>
</div>

<!-- Satellite Detail Panel -->
<div id="sat-panel">
  <div class="ph">
    <div class="ph-top">
      <div class="ph-close" id="ph-close">âœ•</div>
      <div class="ph-dot" id="ph-dot"></div>
      <div class="ph-name" id="ph-name">â€”</div>
      <div class="ph-badge" id="ph-badge">SAT-000</div>
    </div>
    <div class="ph-status-row">
      <div class="status-pill nodata" id="ph-status">
        <div class="status-pill-dot"></div>
        <span id="ph-status-text">LOADING</span>
      </div>
      <div class="ph-updated" id="ph-updated"></div>
    </div>
  </div>
  <div class="pb" id="panel-body"></div>
  <div class="pf">
    <button class="btn" id="ph-refresh">â†» Refresh</button>
    <a href="/" class="btn btn-accent" id="ph-dashlink">ğŸ“Š Full Dashboard</a>
  </div>
</div>

<!-- Controls Hint -->
<div id="hints">
  <div class="hint-row">ğŸ–± Drag to rotate</div>
  <div class="hint-row">âš² Scroll to zoom</div>
  <div class="hint-row">ğŸ›° Click satellite to inspect</div>
</div>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SATELLITE DEFINITIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SATS = [
  { id:1, name:'NASTP-01', type:'LEO', alt:'550 km', inc:45,  r:1.35, period:90,  phase:0.0, hex:'#4d9ef5', hasData:true  },
  { id:2, name:'NASTP-02', type:'SSO', alt:'600 km', inc:97,  r:1.40, period:98,  phase:2.5, hex:'#3fb950', hasData:true  },
  { id:3, name:'NASTP-03', type:'LEO', alt:'500 km', inc:28,  r:1.32, period:85,  phase:1.2, hex:'#bc8cff', hasData:false },
  { id:4, name:'NASTP-04', type:'MEO', alt:'780 km', inc:63,  r:1.50, period:110, phase:4.1, hex:'#ffa657', hasData:false },
  { id:5, name:'NASTP-05', type:'SSO', alt:'640 km', inc:82,  r:1.44, period:97,  phase:5.8, hex:'#39c5aa', hasData:false },
];

const TEX = 'https://cdn.jsdelivr.net/gh/mrdoob/three.js/examples/textures/planets/';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SCENE SETUP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas   = document.getElementById('globe-canvas');
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.15;

const scene  = new THREE.Scene();
scene.background = new THREE.Color(0x060a10);

const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.01, 100);
camera.position.set(0, 1.2, 3.8);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping   = true;
controls.dampingFactor   = 0.06;
controls.minDistance     = 1.6;
controls.maxDistance     = 9;
controls.rotateSpeed     = 0.45;
controls.zoomSpeed       = 0.8;
controls.autoRotate      = true;
controls.autoRotateSpeed = 0.15;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LIGHTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const sunLight = new THREE.DirectionalLight(0xfff5e0, 2.8);
sunLight.position.set(6, 3, 5);
scene.add(sunLight);

const ambient = new THREE.AmbientLight(0x0d1f44, 1.2);
scene.add(ambient);

const fillLight = new THREE.DirectionalLight(0x1133aa, 0.4);
fillLight.position.set(-5, -2, -3);
scene.add(fillLight);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PROCEDURAL STARS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function buildStars() {
  const count = 8000;
  const pos   = new Float32Array(count * 3);
  const sizes = new Float32Array(count);
  for (let i = 0; i < count; i++) {
    const theta = Math.random() * Math.PI * 2;
    const phi   = Math.acos(2 * Math.random() - 1);
    const r     = 28 + Math.random() * 22;
    pos[i*3]   = r * Math.sin(phi) * Math.cos(theta);
    pos[i*3+1] = r * Math.cos(phi);
    pos[i*3+2] = r * Math.sin(phi) * Math.sin(theta);
    sizes[i]   = Math.random() < 0.05 ? 0.08 : 0.04;
  }
  const geo = new THREE.BufferGeometry();
  geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
  geo.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
  const mat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.04, sizeAttenuation: true, transparent: true, opacity: 0.85 });
  scene.add(new THREE.Points(geo, mat));
})();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EARTH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EARTH_R  = 1.0;
const earthGeo = new THREE.SphereGeometry(EARTH_R, 64, 64);
let   earthMesh;

const loader = new THREE.TextureLoader();

function buildEarth(dayTex, specTex, bumpTex) {
  const mat = new THREE.MeshPhongMaterial({
    map:       dayTex  || null,
    specularMap: specTex || null,
    bumpMap:   bumpTex || null,
    bumpScale: 0.015,
    specular:  new THREE.Color(0x1a3a55),
    shininess: 20,
    color:     dayTex ? 0xffffff : 0x1a4a7a,
  });
  if (!dayTex) {
    mat.emissive = new THREE.Color(0x061520);
    mat.emissiveIntensity = 0.6;
  }
  earthMesh = new THREE.Mesh(earthGeo, mat);
  scene.add(earthMesh);
}

// Load textures; degrade gracefully
let loaded = 0;
const onLoad = () => { loaded++; if (loaded >= 3) hideLoading(); };
const onErr  = () => { loaded++; if (loaded >= 3) hideLoading(); };

const dayTex  = loader.load(TEX + 'earth_atmos_2048.jpg',  onLoad, undefined, onErr);
const specTex = loader.load(TEX + 'earth_specular_2048.jpg', onLoad, undefined, onErr);
const bumpTex = loader.load(TEX + 'earth_normal_2048.jpg',  onLoad, undefined, onErr);
buildEarth(dayTex, specTex, bumpTex);

// Atmosphere haze (inner)
scene.add(new THREE.Mesh(
  new THREE.SphereGeometry(EARTH_R * 1.025, 48, 24),
  new THREE.MeshBasicMaterial({ color: 0x3399ff, transparent: true, opacity: 0.06, side: THREE.BackSide, blending: THREE.AdditiveBlending, depthWrite: false })
));
// Outer glow
scene.add(new THREE.Mesh(
  new THREE.SphereGeometry(EARTH_R * 1.09, 32, 16),
  new THREE.MeshBasicMaterial({ color: 0x0055cc, transparent: true, opacity: 0.035, side: THREE.BackSide, blending: THREE.AdditiveBlending, depthWrite: false })
));

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ORBITAL POSITION MATH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Rotation matrix: tilt equatorial orbit (X-Z plane) by 'inc' degrees around X-axis
function orbPos(sat, simSec) {
  const angle = (simSec / (sat.period * 60)) * Math.PI * 2 + sat.phase;
  const inc   = THREE.MathUtils.degToRad(sat.inc);
  return new THREE.Vector3(
    sat.r * Math.cos(angle),
    sat.r * Math.sin(angle) * Math.sin(inc),
    sat.r * Math.sin(angle) * Math.cos(inc)
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SATELLITES + ORBITAL PATHS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const satGroups = [];
const satBodies = [];   // raycasting targets
const liveData  = SATS.map(s => ({ ...s, status: 'loading', telemetry: null, alerts: [], stats: null }));

SATS.forEach((sat, i) => {
  const color = new THREE.Color(sat.hex);

  // â”€â”€ Orbital path â”€â”€
  const pathPts = [];
  const SEG = 192;
  for (let j = 0; j <= SEG; j++) {
    pathPts.push(orbPos(sat, (j / SEG) * sat.period * 60));
  }
  const pathGeo = new THREE.BufferGeometry().setFromPoints(pathPts);
  const pathMat = new THREE.LineBasicMaterial({ color, transparent: true, opacity: 0.2, depthWrite: false });
  scene.add(new THREE.Line(pathGeo, pathMat));

  // â”€â”€ Satellite group â”€â”€
  const g = new THREE.Group();

  // Core body
  const body = new THREE.Mesh(
    new THREE.SphereGeometry(0.024, 20, 20),
    new THREE.MeshBasicMaterial({ color })
  );
  g.add(body);
  satBodies.push(body);

  // Inner glow
  g.add(new THREE.Mesh(
    new THREE.SphereGeometry(0.04, 16, 16),
    new THREE.MeshBasicMaterial({ color, transparent: true, opacity: 0.3, blending: THREE.AdditiveBlending, depthWrite: false })
  ));

  // Outer glow
  g.add(new THREE.Mesh(
    new THREE.SphereGeometry(0.065, 16, 16),
    new THREE.MeshBasicMaterial({ color, transparent: true, opacity: 0.1, blending: THREE.AdditiveBlending, depthWrite: false })
  ));

  // Solar panels (2 wings)
  const panelMat = new THREE.MeshBasicMaterial({ color: 0x1a4a88 });
  [-1, 1].forEach(dir => {
    const panel = new THREE.Mesh(new THREE.BoxGeometry(0.05, 0.01, 0.003), panelMat);
    panel.position.x = dir * 0.037;
    g.add(panel);
  });

  scene.add(g);
  satGroups.push(g);

  // â”€â”€ Legend item â”€â”€
  const item = document.createElement('div');
  item.className = 'legend-item';
  item.dataset.idx = i;
  item.innerHTML = `
    <div class="legend-dot" style="background:${sat.hex};color:${sat.hex}"></div>
    <div class="legend-info">
      <div class="legend-name">${sat.name}</div>
      <div class="legend-type">${sat.type} Â· ${sat.alt}</div>
    </div>
    <div class="legend-status" id="leg-s-${i}" style="background:#2a3a4a"></div>
  `;
  item.addEventListener('click', () => openPanel(i));
  document.getElementById('legend').appendChild(item);
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RAYCASTING (hover + click)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const raycaster = new THREE.Raycaster();
const mouse     = new THREE.Vector2();
const tooltip   = document.getElementById('tooltip');
let hoveredIdx  = -1;
let selectedIdx = -1;

function updateMouse(e) {
  const r = canvas.getBoundingClientRect();
  mouse.x =  ((e.clientX - r.left) / r.width)  * 2 - 1;
  mouse.y = -((e.clientY - r.top)  / r.height) * 2 + 1;
}

canvas.addEventListener('mousemove', e => {
  updateMouse(e);
  raycaster.setFromCamera(mouse, camera);
  const hits = raycaster.intersectObjects(satBodies);
  if (hits.length > 0) {
    const idx = satBodies.indexOf(hits[0].object);
    if (idx !== hoveredIdx) {
      hoveredIdx = idx;
      const s = SATS[idx];
      document.getElementById('tt-name').textContent = s.name;
      document.getElementById('tt-meta').textContent = `${s.type} Â· ${s.alt} Â· Inc ${s.inc}Â°`;
    }
    tooltip.style.left = (e.clientX + 16) + 'px';
    tooltip.style.top  = (e.clientY - 38) + 'px';
    tooltip.classList.add('show');
    canvas.style.cursor = 'pointer';
  } else {
    hoveredIdx = -1;
    tooltip.classList.remove('show');
    canvas.style.cursor = 'default';
  }
});

canvas.addEventListener('click', e => {
  updateMouse(e);
  raycaster.setFromCamera(mouse, camera);
  const hits = raycaster.intersectObjects(satBodies);
  if (hits.length > 0) {
    openPanel(satBodies.indexOf(hits[0].object));
  }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PANEL OPEN / CLOSE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let refreshTimer = null;

function openPanel(idx) {
  selectedIdx = idx;
  const sat   = liveData[idx];
  const s     = SATS[idx];

  document.querySelectorAll('.legend-item').forEach((el, i) => el.classList.toggle('active', i === idx));

  document.getElementById('ph-dot').style.background     = s.hex;
  document.getElementById('ph-dot').style.boxShadow      = `0 0 8px ${s.hex}`;
  document.getElementById('ph-name').textContent          = s.name;
  document.getElementById('ph-badge').textContent         = `SAT-${String(s.id).padStart(3,'0')}`;
  document.getElementById('ph-dashlink').href             = `/?sat=${s.id}`;
  document.getElementById('sat-panel').classList.add('open');
  controls.autoRotate = false;

  renderPanel(idx);
  fetchSatData(idx);

  if (refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(() => { if (selectedIdx >= 0) fetchSatData(selectedIdx); }, 10_000);
}

function closePanel() {
  selectedIdx = -1;
  document.getElementById('sat-panel').classList.remove('open');
  document.querySelectorAll('.legend-item').forEach(el => el.classList.remove('active'));
  controls.autoRotate = true;
  if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; }
}

document.getElementById('ph-close').addEventListener('click', closePanel);
document.getElementById('ph-refresh').addEventListener('click', () => { if (selectedIdx >= 0) fetchSatData(selectedIdx); });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// API DATA FETCHING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchSatData(idx) {
  const d = liveData[idx];
  // Bug fix 1: satellites without live data must be marked 'nodata', not left as 'loading'
  if (!d.hasData) { d.status = 'nodata'; if (idx === selectedIdx) renderPanel(idx); return; }

  try {
    const [tRes, aRes, sRes] = await Promise.all([
      fetch(`/telemetry/latest?satellite_id=${d.id}`),
      fetch(`/alerts?satellite_id=${d.id}`),
      fetch(`/stats/satellite/${d.id}`),
    ]);

    if (tRes.ok)    d.telemetry = await tRes.json();
    if (aRes.ok)    d.alerts    = (await aRes.json()).alerts || [];
    if (sRes.ok)    d.stats     = await sRes.json();

    // Bug fix 2: if no telemetry came back (seed data missing / 404), show NO DATA
    // instead of a misleading NOMINAL green status with all "â€”" values
    if (!d.telemetry) {
      d.status = 'nodata';
    } else {
      const hasRed    = d.alerts.some(a => a.level === 'RED');
      const hasYellow = d.alerts.some(a => a.level === 'YELLOW');
      d.status = hasRed ? 'critical' : hasYellow ? 'warning' : 'nominal';
    }
    setLegendStatus(idx, d.status);

    // Update satellite glow color based on status
    const col = d.status === 'critical' ? 0xf85149 : d.status === 'warning' ? 0xe3a525 : new THREE.Color(SATS[idx].hex).getHex();
    satBodies[idx].material.color.setHex(col);
    satGroups[idx].children[1].material.color.setHex(col);
    satGroups[idx].children[2].material.color.setHex(col);

  } catch {
    d.status = 'error';
    setLegendStatus(idx, 'error');
  }
  // Race-condition fix: only update the panel DOM when this satellite is the active one.
  // Background pre-fetches for other satellites must not overwrite the open panel.
  if (idx === selectedIdx) renderPanel(idx);
}

function setLegendStatus(idx, status) {
  const el = document.getElementById(`leg-s-${idx}`);
  if (!el) return;
  const map = { nominal:'#3fb950', warning:'#e3a525', critical:'#f85149', error:'#7a8ea6', loading:'#2a3a4a', nodata:'#2a3a4a' };
  el.style.background   = map[status] || '#2a3a4a';
  el.style.boxShadow    = status === 'nominal' ? '0 0 5px #3fb950' : status === 'critical' ? '0 0 5px #f85149' : 'none';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PANEL RENDER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const METRICS = [
  { key:'battery_voltage', label:'Battery Voltage', icon:'ğŸ”‹', unit:'mV',  min:9000, max:15000, warnBelow:12000, critBelow:10800, dp:0 },
  { key:'battery_temp',    label:'Battery Temp',    icon:'ğŸŒ¡ï¸', unit:'Â°C',  min:-10,  max:50,    warnAbove:35,   critAbove:45,   dp:0 },
  { key:'msi_temperature', label:'MSI Temperature', icon:'ğŸ”¥', unit:'Â°C',  min:0,    max:70,    warnAbove:35,   critAbove:40,   dp:0 },
  { key:'ssr_used',        label:'SSR Used',        icon:'ğŸ’¾', unit:'MB',  min:0,    max:8192,  warnAbove:6000, critAbove:7500, dp:0 },
];

function metricClass(m, v) {
  if (v == null) return '';
  if ((m.critAbove != null && v >= m.critAbove) || (m.critBelow != null && v <= m.critBelow)) return 'crit';
  if ((m.warnAbove != null && v >= m.warnAbove) || (m.warnBelow != null && v <= m.warnBelow)) return 'warn';
  return 'ok';
}
function metricColor(cls) { return { ok:'#3fb950', warn:'#e3a525', crit:'#f85149' }[cls] || '#4a5a6a'; }
function barPct(m, v)     { return v == null ? 0 : Math.min(100, Math.max(0, ((v - m.min)/(m.max - m.min))*100)); }
function fmtNum(v, dp)    { return v == null ? 'â€”' : v.toFixed(dp).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }

function renderPanel(idx) {
  const d   = liveData[idx];
  const sat = SATS[idx];
  const tlm = d.telemetry;

  // Status pill
  const pillEl  = document.getElementById('ph-status');
  const textEl  = document.getElementById('ph-status-text');
  const pillMap = {
    nominal:  ['nominal',  'â— NOMINAL'],
    warning:  ['warning',  'â–² WARNING'],
    critical: ['critical', 'âœ– CRITICAL'],
    error:    ['nodata',   '? ERROR'],
    loading:  ['nodata',   'â€¦ LOADING'],
    nodata:   ['nodata',   'â€” NO DATA'],
  };
  const [cls, txt] = pillMap[d.status] || ['nodata', 'â€” UNKNOWN'];
  pillEl.className  = `status-pill ${cls}`;
  textEl.textContent = txt;

  const updEl = document.getElementById('ph-updated');
  updEl.textContent = tlm?.received_at
    ? `Updated ${new Date(tlm.received_at * 1000).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit', second:'2-digit' })}`
    : '';

  const body = document.getElementById('panel-body');

  body.innerHTML = `
    <!-- Orbit Parameters -->
    <div>
      <div class="sec-lbl">Orbit Parameters</div>
      <div class="orbit-grid">
        <div class="orbit-cell"><div class="orbit-cell-label">Altitude</div><div class="orbit-cell-val">${sat.alt}</div></div>
        <div class="orbit-cell"><div class="orbit-cell-label">Inclination</div><div class="orbit-cell-val">${sat.inc}Â°</div></div>
        <div class="orbit-cell"><div class="orbit-cell-label">Orbit Type</div><div class="orbit-cell-val">${sat.type}</div></div>
        <div class="orbit-cell"><div class="orbit-cell-label">Period</div><div class="orbit-cell-val">${sat.period} min</div></div>
      </div>
    </div>

    <!-- Live Telemetry -->
    <div>
      <div class="sec-lbl">Live Telemetry${!sat.hasData ? ' <span style="color:var(--dim2);font-weight:400;font-size:9px">Â· Simulated</span>' : ''}</div>
      <div class="metrics-grid">
        ${METRICS.map(m => {
          const v   = tlm ? tlm[m.key] : null;
          const cls = metricClass(m, v);
          const col = metricColor(cls);
          const pct = barPct(m, v);
          return `
            <div class="mc ${cls}">
              <div class="mc-icon">${m.icon}</div>
              <div class="mc-lbl">${m.label}</div>
              <div class="mc-val" style="color:${col}">${fmtNum(v, m.dp)}</div>
              <div class="mc-unit">${m.unit}</div>
              <div class="mc-bar"><div class="mc-bar-fill" style="width:${pct}%;background:${col}"></div></div>
              <canvas class="mc-spark" id="spk-${idx}-${m.key}" height="30"></canvas>
              ${!sat.hasData ? '<div class="mc-nodata">No live data</div>' : ''}
            </div>`;
        }).join('')}
      </div>
    </div>

    <!-- Active Alerts -->
    <div>
      <div class="sec-lbl">Active Alerts <span style="color:var(--dim);font-weight:400">(${d.alerts.length})</span></div>
      <div class="alert-list">
        ${d.alerts.length === 0
          ? `<div class="no-alerts">âœ“ All systems nominal â€” no active alerts</div>`
          : d.alerts.map(a => `
              <div class="alert-row ${a.level.toLowerCase()}">
                <div class="alert-lvl ${a.level.toLowerCase()}">${a.level}</div>
                <div>
                  <div class="alert-msg">${a.message}</div>
                  <div class="alert-field">${a.field} = ${a.value}</div>
                </div>
              </div>`).join('')}
      </div>
    </div>

    <!-- Statistics -->
    <div>
      <div class="sec-lbl">24h Statistics</div>
      ${d.stats ? `
        <div class="stats-grid">
          <div class="stat-cell"><div class="stat-cell-lbl">Avg Voltage</div><div class="stat-cell-val">${fmtNum(d.stats.avg_battery_voltage_mv, 0)} mV</div></div>
          <div class="stat-cell"><div class="stat-cell-lbl">Min Voltage</div><div class="stat-cell-val">${fmtNum(d.stats.min_battery_voltage_mv, 0)} mV</div></div>
          <div class="stat-cell"><div class="stat-cell-lbl">Max Voltage</div><div class="stat-cell-val">${fmtNum(d.stats.max_battery_voltage_mv, 0)} mV</div></div>
          <div class="stat-cell"><div class="stat-cell-lbl">Avg MSI Temp</div><div class="stat-cell-val">${fmtNum(d.stats.avg_msi_temperature_c, 1)}Â°C</div></div>
          <div class="stat-cell"><div class="stat-cell-lbl">Max MSI Temp</div><div class="stat-cell-val">${fmtNum(d.stats.max_msi_temperature_c, 1)}Â°C</div></div>
          <div class="stat-cell"><div class="stat-cell-lbl">Total Pkts</div><div class="stat-cell-val">${d.stats.total_packets ?? 0}</div></div>
        </div>` : `<div style="color:var(--dim2);font-size:11px;padding:6px 0">No statistics available</div>`}
    </div>
  `;

  if (sat.hasData) loadSparklines(idx);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SPARKLINES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSparklines(idx) {
  const d    = liveData[idx];
  const to   = Math.floor(Date.now() / 1000);
  const from = to - 86400;
  try {
    const res  = await fetch(`/telemetry/history?satellite_id=${d.id}&from=${from}&to=${to}`);
    if (!res.ok) return;
    const json = await res.json();
    const recs = json.records || [];
    if (recs.length < 2) return;
    METRICS.forEach(m => {
      const el = document.getElementById(`spk-${idx}-${m.key}`);
      if (!el) return;
      drawSparkline(el, recs.map(r => r[m.key]).filter(v => v != null), m);
    });
  } catch { /* ignore */ }
}

function drawSparkline(el, vals, m) {
  if (!vals || vals.length < 2) return;
  const W = el.offsetWidth || 140, H = 30;
  el.width  = W * devicePixelRatio;
  el.height = H * devicePixelRatio;
  el.style.width  = W + 'px';
  el.style.height = H + 'px';
  const ctx = el.getContext('2d');
  ctx.scale(devicePixelRatio, devicePixelRatio);
  ctx.clearRect(0, 0, W, H);

  const mn  = Math.min(...vals), mx = Math.max(...vals), rng = (mx - mn) || 1;
  const pts = vals.map((v, i) => ({ x: (i / (vals.length - 1)) * W, y: H - 2 - ((v - mn) / rng) * (H - 5) }));
  const lv  = vals[vals.length - 1];
  const col = metricColor(metricClass(m, lv));

  // Gradient fill
  const grad = ctx.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, col + '44');
  grad.addColorStop(1, col + '00');
  ctx.beginPath();
  pts.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
  ctx.lineTo(W, H); ctx.lineTo(0, H); ctx.closePath();
  ctx.fillStyle = grad; ctx.fill();

  // Line
  ctx.beginPath();
  pts.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
  ctx.strokeStyle = col; ctx.lineWidth = 1.5; ctx.lineJoin = 'round'; ctx.stroke();

  // Endpoint dot
  const lp = pts[pts.length - 1];
  ctx.beginPath(); ctx.arc(lp.x, lp.y, 2.5, 0, Math.PI * 2);
  ctx.fillStyle = col; ctx.fill();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ANIMATION LOOP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const clock  = new THREE.Clock();
let simTime  = 0;
// Bug fix 3: slider value="1" â†’ Math.pow(10,1) = 10; was initialised to 60 causing
// a jarring speed jump the first time the user touched the slider.
let simSpeed = 10; // matches slider default value="1" (10^1 = 10Ã—)

function fmtSpeed(s) {
  if (s >= 1000) return `${(s/1000).toFixed(1)}kÃ—`;
  if (s >= 10)   return `${Math.round(s)}Ã—`;
  return `${s.toFixed(1)}Ã—`;
}
document.getElementById('speed-val').textContent = fmtSpeed(simSpeed);

document.getElementById('speed-range').addEventListener('input', e => {
  simSpeed = Math.pow(10, parseFloat(e.target.value));
  document.getElementById('speed-val').textContent = fmtSpeed(simSpeed);
});

function animate() {
  requestAnimationFrame(animate);
  const dt = clock.getDelta();
  simTime += dt * simSpeed;

  // Slow Earth rotation
  if (earthMesh) earthMesh.rotation.y += dt * 0.025;

  // Update satellites
  SATS.forEach((sat, i) => {
    const pos = orbPos(sat, simTime);
    satGroups[i].position.copy(pos);
    satGroups[i].rotation.y += dt * 0.8;

    // Pulse glow on selected / hovered
    const isSelected = i === selectedIdx;
    const isHovered  = i === hoveredIdx;
    const t          = simTime;
    const innerScale = isSelected ? 1 + 0.4 * Math.sin(t * 4) : isHovered ? 1.3 : 1;
    const outerScale = isSelected ? 1 + 0.6 * Math.sin(t * 4) : isHovered ? 1.4 : 1;
    satGroups[i].children[1].scale.setScalar(innerScale);
    satGroups[i].children[2].scale.setScalar(outerScale);
  });

  controls.update();
  renderer.render(scene, camera);
}

animate();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RESIZE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOADING SCREEN DISMISS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hideLoading() {
  const el = document.getElementById('loading');
  el.style.opacity = '0';
  setTimeout(() => el.style.display = 'none', 500);
}
// Fallback: hide after 5s regardless
setTimeout(hideLoading, 5000);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INITIAL DATA LOAD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SATS.forEach((s, i) => {
  if (s.hasData) {
    fetchSatData(i).then(() => setLegendStatus(i, liveData[i].status));
  }
  // Set initial dot color
  setLegendStatus(i, s.hasData ? 'loading' : 'nodata');
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MONGODB HEALTH BADGE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkDbHealth() {
  const badge = document.getElementById('db-badge');
  const text  = document.getElementById('db-status-text');
  try {
    const r = await fetch('/health/db');
    const d = await r.json();
    if (d.status === 'connected') {
      badge.className = 'db-badge connected';
      text.textContent = `MONGO  ${d.latency_ms}ms`;
      badge.title = `MongoDB Atlas â€” Connected\nLatency: ${d.latency_ms} ms\nTelemetry: ${d.telemetry_docs.toLocaleString()} docs\nAlerts: ${d.alert_docs.toLocaleString()} docs`;
    } else {
      badge.className = 'db-badge disconnected';
      text.textContent = 'MONGO  âœ•';
      badge.title = `MongoDB Atlas â€” Disconnected\n${d.error || ''}`;
    }
  } catch (_) {
    badge.className = 'db-badge disconnected';
    text.textContent = 'MONGO  âœ•';
    badge.title = 'MongoDB Atlas â€” Unreachable';
  }
}
checkDbHealth();
setInterval(checkDbHealth, 5000);

</script>
</body>
</html>
